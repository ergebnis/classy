language: php

env:
  global:
    - secure: "nmx1vFaZe5UtDp6up/uHKUM6oI744kyVFm8Uvt/gCIiy0o9UZrt6lmSAbC1eDlpzLC+zgXpDKxrjei4MmRYqk8aRpDGWjD1w9ydu4Rj1wfJ0fPEuaT1SE7RUiaHS+MmZMijZjt0gqGrz10wq1kthtAkuy0Zpf4JuEuDB+dc3eQMdVEYvkx3OxpWGVu5OeRnAtzWYxuvRQXXbisODUYSemYhdJiRe5OoCF1ObyubJzQQEZNTgkpek+5+04KZrUhI+PggmSnZdNBkDsU8tQFNFML1e7B5o3b5IqqAi3ke+F//8unboS/1wjpiRF7+TmDNfsmcnpDA8NmctuylWNRLXWko7r9Nfad90fQCnA+2HQhZ+RqEV4EBP0ixOXCMv+ff3357VyEAifYyAtSdW9eJFJVa36AlD51EtSRz+X6XdK57Q9rk7e3PCEuneizcXjQg5Zjs1V6jXCesAB95/+j0+1YYx18UzCHV7H3x8cuOKaoISDQBqALLoHmWka0CBDC2isjuLCpV012WBF3Wo8jSQc94IrbyWvjkpLVRdrl95lFQyb54blu2+u+Axh0qnasKdzyP4+18kKXlO19VuGUR7nEVAq54wmdLxluBb808WnsXIXFWjBfl/K+TN/AA6eyHuK3znCscM1pJokFiJDGMsrsfOYWu2RNuLDBMrLUn80Hg="

cache:
  directories:
    - $HOME/.composer/cache
    - $HOME/.php-cs-fixer
    - $HOME/.phpstan

stages:
  - style
  - stan
  - test
  - infection

jobs:
  include:
    - stage: Style

      php: 7.1

      before_install:
        - source .travis/xdebug.sh
        - xdebug-disable
        - composer validate
        - if [[ -n "$GITHUB_TOKEN" ]]; then composer config github-oauth.github.com $GITHUB_TOKEN; fi

      install:
        - composer install

      before_script:
        - mkdir -p $HOME/.php-cs-fixer

      script:
        - vendor/bin/php-cs-fixer fix --config=.php_cs --diff --dry-run --verbose

    - stage: Stan

      php: 7.1

      before_install:
        - source .travis/xdebug.sh
        - xdebug-disable
        - composer validate
        - if [[ -n "$GITHUB_TOKEN" ]]; then composer config github-oauth.github.com $GITHUB_TOKEN; fi

      install:
        - composer install

      before_script:
        - mkdir -p $HOME/.phpstan

      script:
        - vendor/bin/phpstan analyse --configuration=phpstan.neon --level=max src test

    - &TEST

      stage: Test

      php: 7.1

      env: WITH_LOWEST=true

      before_install:
        - source .travis/xdebug.sh
        - xdebug-disable
        - composer validate
        - if [[ -n "$GITHUB_TOKEN" ]]; then composer config github-oauth.github.com $GITHUB_TOKEN; fi

      install:
        - if [[ "$TRAVIS_PHP_VERSION" == "7.2" ]]; then composer remove --dev localheinz/php-cs-fixer-config; fi
        - if [[ "$WITH_LOWEST" == "true" ]]; then composer update --prefer-lowest; fi
        - if [[ "$WITH_LOCKED" == "true" ]]; then composer install; fi
        - if [[ "$WITH_HIGHEST" == "true" ]]; then composer update; fi

      script:
        - vendor/bin/phpunit --configuration=test/AutoReview/phpunit.xml
        - if [[ "$WITH_COVERAGE" == "true" ]]; then xdebug-enable; fi
        - if [[ "$WITH_COVERAGE" == "true" ]]; then vendor/bin/phpunit --configuration=test/Unit/phpunit.xml --coverage-clover=build/logs/clover.xml; else vendor/bin/phpunit --configuration=test/Unit/phpunit.xml; fi
        - if [[ "$WITH_COVERAGE" == "true" ]]; then xdebug-disable; fi

      after_success:
        - if [[ "$WITH_COVERAGE" == "true" ]]; then bash <(curl -s https://codecov.io/bash); fi

    - <<: *TEST

      php: 7.1

      env: WITH_LOCKED=true

    - <<: *TEST

      php: 7.1

      env: WITH_HIGHEST=true

    - <<: *TEST

      php: 7.2

      env: WITH_LOWEST=true

    - <<: *TEST

      php: 7.2

      env: WITH_LOCKED=true WITH_COVERAGE=true

    - <<: *TEST

      php: 7.2

      env: WITH_HIGHEST=true

    - stage: Infection

      php: 7.2

      before_install:
        - source .travis/xdebug.sh
        - xdebug-disable
        - composer validate
        - if [[ -n "$GITHUB_TOKEN" ]]; then composer config github-oauth.github.com $GITHUB_TOKEN; fi

      install:
        - composer install

      before_script:
        - xdebug-enable

      script:
        - vendor/bin/infection --min-covered-msi=87 --min-msi=87

notifications:
  email: false
